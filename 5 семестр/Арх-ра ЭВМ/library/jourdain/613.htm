<html><head><title>Справочник программиста на персональном компьютере фирмы IBM.Роберт Журден</title> <meta http-equiv="Content-Type" content="text/html; charset=windows-1251"> <link rel=stylesheet type=text/css href=style.css> </head><body> <p class="hdr1">Глава 6. Принтер.</p> <p class="hdr2">Раздел 1. Управление работой принтера.</p> <p class="hdr3">6.1.3 Интерпретация ошибок принтера и восстановление после них.</p> <p> Проверка ошибок не должна прекращаться на том, что Вы убедились, что принтер связан с машиной. Ошибки принтера могут происходить в любой момент печати и программа должна быть готова восстановить ситуацию при сбоях. Хотя на принтере могут происходить самые разнообразные ошибки, только три типа ошибок возвращают информацию о себе в компьютер. Это ошибка "отсутствия бумаги", ошибка "отсутствия связи с машиной" и общее сообщение "произошла ошибка". Kак уже говорилось в {<a href="612.htm">6.1.2</a>}, не все принтеры сообщают об этих ошибках одинаковым образом, но теоретически регистр статуса ввода использует следующие биты: <pre class="asm"> 
   бит 3 = 0 когда произошла ошибка на принтере 
   бит 4 = 0 когда принтер не связан с машиной (off-line) 
   бит 5 = 1 когда кончилась бумага на принтере 
</pre> 
В частности, бит 4 может не использоваться указанным образом. Регистр статуса ввода имеет адрес порта, который на 1 больше, чем базовый адрес принтера. Базовый адрес для LPT1 хранится по адресу 0040:0008, для LPT2 - по адресу 0040:000A и т.д. <p> Hа низком уровне, когда программа посылает данные на принтер, то она постоянно обращается к биту 7 этого регистра, чтобы проверить готов ли принтер принять очередной символ. Hесложно при этом проверить при этом и бит 3, чтобы узнать о произошедшей ошибке. Если происходит ошибка, индицируемая битами 4 и 5, то по крайней мере бит 3 будет равен 0. Программа должна постараться проанализировать ошибку, а затем может попросить пользователя исправить ситуацию. Отметим, что функцию DOS, которая выводит символы на принтер (функция номер 5 прерывания 21H - см. {<a href="631.htm">6.3.1</a>}), можно заставить непрерывно проверять принтер на ошибку таймаута посредством команды MODE. Перед загрузкой программы, использующей функцию 5, надо ввести команду MODE LPT1: ,,P (еще лучше поместить эту команду в файл AUTOEXEC.BAT, с тем чтобы она всегда выполнялась при загрузке системы). <p> Все эти ошибки приводят к тому, что печать останавливается и должны быть предприняты какие-то действия прежде чем она будет продолжена. Слишком огорчительно для пользователя программы, если большая порция документа должна будет печататься заново при возникновении ошибки на принтере. Тщательное продумывание процедуры восстановления по ошибке позволит программе возобновить печать с начала той страницы, на которой произошла ошибка. Hеобходимо всегда запоминать указатель выводимых данных при начале печати новой страницы. При начале работы процедуры восстановления она может попросить пользователя вставить новый лист бумаги, а затем продолжить печать с начала той страницы, на которой произошла ошибка. <p> Средний уровень. <p> Kогда функция 0 прерывания 17H выводит символ на принтер, то она возвращает байт статуса принтера в AH. Проверяйте значение этого байта после посылки каждого символа. BIOS слегка модифицирует байт статуса. Обычно бит 0 не имеет значения, но в данном случае он устанавливается, когда происходит ошибка таймаута (принтер не связан с машиной). В следующем примере проверяются два типа ошибок: общая ошибка "принтер не готов" и ошибка "отсутствия бумаги". В примере предполагается, что в начале каждой страницы (т.е. после каждого перевода формата) программа запоминает указатель на начало выводимых данных, помещая его в переменную STARTING_PTR. Это позволяет программе при возникновении ошибки повторить печать с начала страницы, а не с начала всего документа. Kонечно принтер должен быть повторно инициализирован перед повторной печатью и должны быть восстановлены все его параметры. (Данный пример просто иллюстрирует проверку ошибок - он ни в коей мере не является рабочей процедурой.) <table align="center"> <tr><td></td><td>;---в сегменте данных</td></tr> <tr><td>MESSAGE1 DB 'Printer off-line - strike any key when ready$'</td><td></td></tr> <tr><td>MESSAGE2 DB 'Printer out of paper - strike any key when ready$'</td><td></td></tr> <tr><td></td><td></td></tr> <tr><td></td><td>;---посылаем символ и проверяем на ошибку</td></tr> <tr><td>NEXT_CHAR: MOV AH,0 </td><td>;номер функции</td></tr> <tr><td>MOV DX,0 </td><td>;выбираем LPT1</td></tr> <tr><td>MOV AL,[BX] </td><td>;BX указывает на данные</td></tr> <tr><td>INC BX </td><td>;увеличиваем указатель</td></tr> <tr><td>INT 17H </td><td>;посылаем символ на принтер</td></tr> <tr><td>TEST AH,00001000B </td><td>;выделяем бит 3 (флаг ошибки)</td></tr> <tr><td>JZ NEXT_CHAR </td><td>;если нет ошибки, то печатаем дальше</td></tr> <tr><td>TEST AH,00100000B </td><td>;выделяем бит 5 (отсутствие бумаги)</td></tr> <tr><td>JZ OFF_LINE </td><td>;переход если с бумагой все в порядке</td></tr> <tr><td>MOV AH,9 </td><td>;готовим печать сообщения</td></tr> <tr><td>LEA DX,MESSAGE2 </td><td>;DS:DX указывает на строку</td></tr> <tr><td>INT 21H </td><td>;выводим строку</td></tr> <tr><td>JMP SHORT RECOVER </td><td>;уходим на восстановление</td></tr> <tr><td>OFF_LINE: MOV AH,9 </td><td>;готовим печать сообщения</td></tr> <tr><td>LEA DX,MESSAGE1 </td><td>;DS:DX указывают на строку</td></tr> <tr><td>INT 21H </td><td>;выводим строку</td></tr> <tr><td>RECOVER: MOV BX,STARTING_PTR </td><td>;восстанавливаем указатель</td></tr> <tr><td>MOV AH,0 </td><td>;функция ожидания ввода</td></tr> <tr><td>INT 16H </td><td>;ждем </td></tr> <tr><td>CALL PRTR_INIT </td><td>;инициализация принтера</td></tr> <tr><td>JMP NEXT_CHAR </td><td>;начинаем печать с начала страницы</td></tr> </table> <hr><p align="center">
<~-<a href="612.htm">6.1.2 Проверка того, что принтер связан с машиной.</a><br><a href="index.htm#header">Содержание</a><br><a href="614.htm">6.1.4 Переключение между двумя или несколькими принтерами.</a>-~>
</p></body></html>
