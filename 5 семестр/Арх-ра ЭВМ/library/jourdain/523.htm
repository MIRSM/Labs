<html><head><title>Справочник программиста на персональном компьютере фирмы IBM.Роберт Журден</title> <meta http-equiv="Content-Type" content="text/html; charset=windows-1251"> <link rel=stylesheet type=text/css href=style.css> </head><body> <p class="hdr1">Глава 5. Дисковые накопители.</p> <p class="hdr2">Раздел 2. Работа с каталогами диска.</p> <p class="hdr3">5.2.3 Чтение/изменение подкаталога.</p> <p> Подкаталоги во многом подобны корневому каталогу, за исключением того, что они хранятся как обычные файлы, а не в заранее предопределенных секторах. Подкаталоги невозможно спутать с обычными файлами, поскольку объект каталога, относящийся к подкаталогу, имеет специальный байт атрибутов (с установленным битом 5 см. {<a href="526.htm">5.2.6</a>}). Подкаталоги начинаются с двух специальных 32-байтных объектов, первый из которых имеет имя точка, а второй - две  точки. Они ориентируют подкаталог среди окружающих каталогов.  Ссылки на подкаталоги нижнего уровня записываются как обычные ссылки на файлы. <p> Предполагается, что подкаталог может быть прочитан как любой другой файл, поэтому вроде бы не составляет труда загрузить его в память. Hо, к сожалению, создатели MS DOS поместили 0 в поле длины файла для элементов, относящихся к подкаталогам. В результате DOS считает, что этот файл имеет нулевую длину и отказывается читать его. Hет простого способа преодолеть эту проблему. <p> Средний уровень. <p> Функции работы через дескрипторы файлов, которые использовались для доступа к корневому каталогу {<a href="521.htm">5.2.1</a>} могут так же просто обращаться к любому подкаталогу. Чтобы вывести все содержимое каталога надо просто использовать функцию 4EH для поиска файлов *.*, а затем повторять поиск, используя функцию 4FH. Kогда больше не будет файлов, то будет установлен флаг переноса, а AL будет содержать 18. Kаждый раз, когда будет обнаружен очередной элемент, в DTA будет записана информация о файле, включая полный его путь (отмечаем использование DTA в функциях, использующих дескриптор файла). Следующий пример выводит полные пути всех обычных файлов подкаталога. <table align="center"> <tr><td></td><td>;---в сегменте данных</td></tr> <tr><td>PATH DB 'A:MAMMALS\*.*',0</td><td></td></tr> <tr><td>DTAH DB 256 DUP(?)</td><td></td></tr> <tr><td></td><td></td></tr> <tr><td></td><td>;---установка DTA</td></tr> <tr><td>LEA DX,DTA </td><td>;DS:DX указывают на DTA</td></tr> <tr><td>MOV AH,1AH </td><td>;функция установки DTA</td></tr> <tr><td>INT 21H </td><td>;устанавливаем DTA</td></tr> <tr><td></td><td>;---ищем первый файл</td></tr> <tr><td>MOV AH,4EH </td><td>;номер функции</td></tr> <tr><td>LEA DX,PATH </td><td>;указываем на строку пути</td></tr> <tr><td>MOV CX,0 </td><td>;только нормальные атрибуты</td></tr> <tr><td>INT 21H </td><td>;ищем *.*</td></tr> <tr><td>JC ERROR </td><td>;обработка ошибок</td></tr> <tr><td></td><td>;---выводим имя файла</td></tr> <tr><td>NEXT_LINE: LEA BX,DTA </td><td>;BX указывает на DTA</td></tr> <tr><td>ADD BX,30 </td><td>;смещение для имени файла</td></tr> <tr><td>NEXT_CHAR: MOV DL,[BX] </td><td>;получаем символ из имени</td></tr> <tr><td>CMP DL,0 </td><td>;проверка на конец строки</td></tr> <tr><td>JE END_STR </td><td>;уход, если конец</td></tr> <tr><td>MOV AH,2 </td><td>;иначе, выодим символ</td></tr> <tr><td>INT 21H </td><td>;</td></tr> <tr><td>INC BX </td><td>;увеличиваем указатель</td></tr> <tr><td>JMP SHORT NEXT_CHAR </td><td>;следующий символ</td></tr> <tr><td></td><td>;---возврат каретки/перевод строки в конце строки</td></tr> <tr><td>END_STR: MOV AH,2 </td><td>;функция вывода символа</td></tr> <tr><td>MOV DL,13 </td><td>;код возврата каретки</td></tr> <tr><td>INT 21H </td><td>;выводим</td></tr> <tr><td>MOV DL,10 </td><td>;код перевода строки</td></tr> <tr><td>INT 21H </td><td>;выводим</td></tr> <tr><td></td><td>;---ищем следующий файл</td></tr> <tr><td>LEA DX,PATH </td><td>;указываем на строку пути</td></tr> <tr><td>MOV AH,4FH </td><td>;номер функции</td></tr> <tr><td>INT 21H </td><td>;ищем следующий файл</td></tr> <tr><td>JC FINISHED </td><td>;если нет, то выход</td></tr> <tr><td>JMP SHORT NEXT_LINE </td><td>;иначе выводим имя файла</td></tr> <tr><td>FINISHED:</td><td></td></tr> </table> <hr><p align="center">
<~-<a href="522.htm">5.2.2 Создание/удаление подкаталога.</a><br><a href="index.htm#header">Содержание</a><br><a href="524.htm">5.2.4 Получение/установка текущего каталога.</a>-~>
</p></body></html>
