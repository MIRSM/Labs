<html><head><title>Справочник программиста на персональном компьютере фирмы IBM.Роберт Журден</title> <meta http-equiv="Content-Type" content="text/html; charset=windows-1251"> <link rel=stylesheet type=text/css href=style.css> </head><body> <p class="hdr1">Глава 6. Принтер.</p> <p class="hdr2">Раздел 1. Управление работой принтера.</p> <p class="hdr3">6.1.2 Проверка того, что принтер связан с машиной.</p> <p> Программа всегда должна проверить, что принтер связан с машиной, перед тем, как послать на него вывод. Легко установить, что принтер не готов, так как бит 3 регистра статуса принтера устанавливается в 1 в этом случае. Hо намного сложнее точно определить почему принтер не готов: выключен ли он, отменен выбор принтера или в нем нет бумаги. Это происходит из-за того, что принтеры разных производителей посылают разные наборы битов в регистр статуса принтера, даже когда они находятся в идентичном состоянии. Хотя регистр статуса имеет биты, которые должны показывать эти три состояния принтера, но в реальности значения битов могут не соответствовать этим условиям (бит 3 должен показывать, что принтер выключен, бит 4 - что отменен выбор принтера и бит 5 что нет бумаги). Hижеприведенные значения возвращаются в регистр статуса по стандарту "Эпсон", которому обычно следует IBM: <pre class="asm"> 
   Значение         Цепочка битов          Интерпретация 
     223             11011111           принтер готов 
      87             01010111           принтер не готов 
     119             01110111           нет бумаги в принтере 
     247             11110111           принтер выключен 
</pre> 
<p> Регистр статуса ввода имеет адрес порта на 1 больше, чем базовый адрес принтера. Базовый адрес для LPT1 хранится по адресу 0040:0008, для LPT2 - по адресу 0040:000A и т.д. Имейте в виду, что если принтер был выключен, то ему требуется некоторое время на инициализацию после включения. Hе начинайте печатать до тех пор, пока регистр статуса ввода не сообщит, что принтер связан с машиной и готов к приему данных. <p> Средний уровень. <p> Для получения байта статуса из порта принтера надо использовать функцию 2 прерывания 17H. При входе DX содержит номер LPT (0-2 для LPT1-3). Эта функция сбрасывает три неиспользуемых бита байта и делает операцию исключающего ИЛИ над двумя другими, поэтому значения отличаются от приведенных выше: <pre class="asm"> 
   Значение         Цепочка битов          Интерпретация 
     144             10010000           принтер готов 
      24             00011000           принтер не готов 
     184             10111000           принтер выключен 
</pre> 
И опять необходимо помнить, что эти значения меняются от принтера к принтеру. Hаиболее общую информацию "выключен или не готов" дает бит 3 статуса равный 0. <p> Hизкий уровень. <p> Данный пример делает самое простое - проверяем бит on-line регистра статуса. Для получения байта статуса используется базовый адрес LPT1. <table align="center"> <tr><td></td><td>;---в сегменте</td></tr> <tr><td>MESSAGE DB 'Printer not ready - strike any key when OK$'</td><td></td></tr> <tr><td></td><td></td></tr> <tr><td></td><td>;---проверка связан ли принтер с машиной (on-line)</td></tr> <tr><td>MOV AX,40H </td><td>;ES указывает на область данных BIOS</td></tr> <tr><td>MOV ES,AX </td><td>;</td></tr> <tr><td>MOV DX,ES:[8] </td><td>;получаем базовый адрес</td></tr> <tr><td>INC DX </td><td>;смещение для регистра статуса</td></tr> <tr><td>IN AL,DX </td><td>;получаем байт статуса в AL</td></tr> <tr><td>TEST AL,1000B </td><td>;проверяем бит 3</td></tr> <tr><td>JNZ GO_AHEAD </td><td>;если принтер on-line, то вперед</td></tr> <tr><td></td><td>;---печатаем сообщение об ошибке и ждем нажатия клавиши</td></tr> <tr><td>MOV AH,9 </td><td>;функция вывода строки</td></tr> <tr><td>LEA DX,MESSAGE </td><td>;DS:DX указывают на сообщение</td></tr> <tr><td>INT 21H </td><td>;печатаем сообщение</td></tr> <tr><td>MOV AH,7 </td><td>;функция ожидания ввода</td></tr> <tr><td>INT 21H </td><td>;ожидаем нажатия клавиши (без эха)</td></tr> <tr><td>GO_AHEAD: </td><td>;продолжение программы</td></tr> </table> <hr><p align="center">
<~-<a href="611.htm">6.1.1 Инициализация порта принтера/повторная инициализация принтера.</a><br><a href="index.htm#header">Содержание</a><br><a href="613.htm">6.1.3 Интерпретация ошибок принтера и восстановление после них.</a>-~>
</p></body></html>
