<html><head><title>Справочник программиста на персональном компьютере фирмы IBM.Роберт Журден</title> <meta http-equiv="Content-Type" content="text/html; charset=windows-1251"> <link rel=stylesheet type=text/css href=style.css> </head><body> <p class="hdr1">Глава 3. Kлавиатура.</p> <p class="hdr2">Раздел 2. Доступ к отдельным клавишам.</p> <p class="hdr3">3.2.8 Создание процедуры обработки Ctrl-Break.</p> <p> Kогда вводится комбинация Ctrl-Break, то прерывание клавиатуры устанавливает флаг, указывающий что должна быть выполнена процедура обработки Ctrl-Break. Управление передается этой процедуре только в тот момент, когда программа использует функцию DOS, способную распознавать этот флаг. Обычно только стандартные функции ввода/вывода MS DOS могут распознавать этот флаг (функции от 1 до C прерывания 21H, за исключением функций 6 и 7). Hо поместив строку BREAK=ON либо в файл AUTOEXEC.BAT, либо в CONFIG.SYS, используемые MS DOS при старте системы, Вы получите ситуацию, когда обращение к любой функции DOS приведет к вызову процедуры обработки Ctrl-Break. При этом выполнение программы будет немного замедлено. <p> Процедура обработки Ctrl-Break дает возможность завершить программу в любой момент времени. Kогда функция DOS распознает статус Ctrl-Break, то управление передается процедуре, на которую указывает вектор прерывания 23H. DOS использует эту процедуру для завершения работающей программы. Hо процедура может быть переписана Вами, с тем чтобы она удовлетворяла любым Вашим требованиям. Эта процедура должна быть программируемой, с тем чтобы перед завершением программы могли быть выполнены все критические операции. Может требоваться выравнивание стека, с тем чтобы SP указывал на второе слово от вершины (первое слово для программ COM) перед выполнением завершающей инструкции RET. Вектора прерывания, измененные программой должны быть восстановлены, а все открытые устройства ввода/вывода - закрыты. Если были запрещены прерывания, то надо разрешить их. Все это должно обеспечить машине возможность нормально работать со следующей программой после завершения программы по Ctrl-Break. Другая альтернатива - сделать процедуру обработки Ctrl-Break, состоящей из одной инструкции IRET, что запрещает завершение программы таким способом. <p> Средний уровень. <p> В данном примере выход из программы происходит после выравнивания стека. Процедура кончается инструкцией RET, а не IRET, поскольку в данном случае она действует в точности так же, как и инструкция RET при нормальном завершении программы. В момент, когда она используется, указатель стека (SP) должен указывать на второе слово стека. Это предполагает, что программа в форме EXE. Помните, что стек помещаает свое первое слово в самую старшую ячейку памяти, второе - в ячейку ниже, и т.д. Если размер стека 400 байт, то надо установить SP на 396. Для программ COM надо устанавливать указатель стека на первое слово стека или просто завершать процедуру обработки Ctrl-Break прерыванием 21H. <table align="center"> <tr><td></td><td>;---это новая процедура обработки Ctrl-Break</td></tr> <tr><td>C_B PROC FAR</td><td></td></tr> <tr><td>MOV AX,396 </td><td>;значение для второго слова стека</td></tr> <tr><td>MOV SP,AX </td><td>;выравниваем указатель стека</td></tr> <tr><td>RET </td><td>;возврат в DOS</td></tr> <tr><td>C_B ENDP </td><td>;</td></tr> <tr><td></td><td>;---изменение вектора прерывания</td></tr> <tr><td>PUSH DS </td><td>;сохраняем регистр</td></tr> <tr><td>MOV AX,SEG C_B </td><td>;готовим адрес процедуры</td></tr> <tr><td>MOV DS,AX </td><td>;</td></tr> <tr><td>MOV DX,OFFSET C_B </td><td>;</td></tr> <tr><td>MOV AH,25H </td><td>;номер функции</td></tr> <tr><td>MOV AL,23H </td><td>;номер вектора</td></tr> <tr><td>INT 21H </td><td>;изменяем вектор</td></tr> <tr><td>POP DS </td><td>;восстанавливаем регистр</td></tr> </table> <p> Программа может в любое время проверить был ли сделан запрос на выполнение процедуры обработки Ctrl-Break. Hадо поместить в AL 0 и вызвать функцию 33 прерывания 21H. При возврате DL будет содержать 1, если был установлен флаг прерывания по Ctrl-Break, и 0 - в противном случае. Если при вызове поместить в AL 1, то статус будет установлен. В этом случае, перед вызовом функции, поместите в DL 0 или 1, чтобы флаг был установлен или очищен. <hr><p align="center">
<~-<a href="327.htm">3.2.7 Создание макроопределений для отдельных клавиш.</a><br><a href="index.htm#header">Содержание</a><br><a href="329.htm">3.2.9 Перепрограммирование клавиши PrtSc.</a>-~>
</p></body></html>
