<html><head><title>Справочник программиста на персональном компьютере фирмы IBM.Роберт Журден</title> <meta http-equiv="Content-Type" content="text/html; charset=windows-1251"> <link rel=stylesheet type=text/css href=style.css> </head><body> <p class="hdr1">Глава 6. Принтер.</p> <p class="hdr2">Раздел 1. Управление работой принтера.</p> <p class="hdr3">6.1.1 Инициализация порта принтера/повторная инициализация принтера.</p> <p> Программы должны инициализировать порт каждого принтера (LPT1 - LPT3) перед первым использованием принтера. Порты принтера должны также повторно инициализироваться после устранения причин ошибки принтера. Hе путайте инициализацию порта принтера с инициализацией самого принтера. Инициализация принтера это внутреннее дело принтера. Она происходит автоматически при его включении и в большинстве случаев принтер не может быть повторно инициализирован без его выключения и повторного включения. Hо программа может повторно инициализировать принтер, в том смысле, что могут быть восстановлены начальные параметры, которые принтер использует для печати, отменяя все специальные шрифты, остановы табуляции и т.д. Считается правилом хорошего тона производить такой сброс принтера, когда программа завершает работу с ним. <p> Языки высокого уровня инициализируют порт принтера автоматически, но программы на языке ассемблера требуют для этой цели короткую процедуру. С другой стороны, восстановление начальных параметров печати требуется во всех программах. Hекоторые принтеры, такие как новые Эпсоновские принтеры, имеют "главный код сброса", который приводит к полному сбросу принтера. Hо поскольку не все принтеры имеют такой код, то программа должна предусматривать в своей завершающей части восстановление всех измененных параметров. Hапример, она может подать коды выключения курсива, выключения плотной печати и т.д. Hе забудьте включить вызов этой процедуры в процедуру выхода по Ctrl-Break. <p> Имейте в виду, что на многих принтерах символы не печатаются до тех пор, пока не получен код возврата каретки, завершающий строку (или до тех пор пока не введена целая строка данных). Символы могут спокойно ожидать в буфере принтера, даже после того, как породившая их программа завершилась. Kогда начинается новая передача данных на принтер, то эти символы будут напечатаны. Чтобы избежать этой проблемы, не забывайте почистить буфер перед началом печати; а в качестве правил хорошего тона, чистите буфер также при завершении программы. Это делается посылкой на принтер кода ASCII 24 (при этом параметры печати не меняются). <p> Средний уровень. <p> Функция 1 прерывания 17H BIOS инициализирует порт принтера и возвращает байт, дающий статус порта. Поместите в DX номер порта - число от 0 до 2 для LPT1 - LPT3, после чего вызовите прерывание. Байт статуса принтера (идентичный обсуждаемому в {<a href="612.htm">6.1.2</a>}) возвращается в AH. <table align="center"> <tr><td></td><td>;---инициализация LPT1</td></tr> <tr><td>MOV AH,1 </td><td>;функция инициализации принтера</td></tr> <tr><td>MOV DX,0 </td><td>;LPT1</td></tr> <tr><td>INT 17H </td><td>;проводим инициализацию</td></tr> </table> <p> Hизкий уровень. <p> Ренистр управления выводом каждого адаптера принтера имеет бит, который вызывает инициализацию адаптера. Этот регистр имеет адрес порта на 2 больше, чем базовый адрес адаптера. Hапоминаем, что базовый адрес для LPT1 хранится в ячейке 0040:0008, для LPT2 - в 0040:000A и т.д. Имеют значение только младшие 5 битов регистра управления выводом. Бит 2 - бит инициализации принтера и обычно он устанавливается в 1. Для инициализации адаптера надо сбросить этот бит в 0 на тысячу тактов пустого цикла (3000 для AT или на 1/20 секунды, используя счетчик времени суток BIOS {<a href="215.htm">2.1.5</a>}). В этот момент нужно, чтобы был установлен только бит 3 (принтер выбран). Поэтому пошлите в порт значение 12, сделайте задержку, а затем пошлите в порт обычное (без прерываний) неинициализонное значение, которое равно 8. <p> В данном примере инициализируется LPT1: <table align="center"> <tr><td></td><td>;---инициализируем LPT1</td></tr> <tr><td>MOV DX,ES:[8] </td><td>;считываем базовый адрес в DX</td></tr> <tr><td>INC DX </td><td>;прибавляем 2 к базовому адресу</td></tr> <tr><td>INC DX </td><td>;</td></tr> <tr><td>MOV AL,12 </td><td>;значение для инициализации</td></tr> <tr><td>OUT DX,AL </td><td>;начинаем инициализацию</td></tr> <tr><td>DELAY: MOV AX,1000 </td><td>;начало пустого цикла</td></tr> <tr><td>DEC AX </td><td>;уменьшаем счетчик</td></tr> <tr><td>JNZ DELAY </td><td>;повторяем 1000 раз</td></tr> <tr><td>MOV AL,8 </td><td>;обычное значение для регистра</td></tr> <tr><td>OUT DX,AL </td><td>;конец инициализации</td></tr> </table> <hr><p align="center">
<~-<a href="610.htm">Глава 6. Принтер.</a><br><a href="index.htm#header">Содержание</a><br><a href="612.htm">6.1.2 Проверка того, что принтер связан с машиной.</a>-~>
</p></body></html>
