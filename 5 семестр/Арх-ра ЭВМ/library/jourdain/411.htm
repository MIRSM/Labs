<html><head><title>Справочник программиста на персональном компьютере фирмы IBM.Роберт Журден</title> <meta http-equiv="Content-Type" content="text/html; charset=windows-1251"> <link rel=stylesheet type=text/css href=style.css> </head><body> <p class="hdr1">Глава 4. Вывод на терминал.</p> <p class="hdr2">Раздел 1. Управление выводом на терминал.</p> <p class="hdr3">4.1.1 Программирование контроллера дисплея 6845.</p> <p> Все видеосистемы строятся вокруг микросхемы контроллера видеотерминала Motorola 6845 (EGA использует заказную микросхему, основанную на 6845). Микросхема используется во многом аналогично в монохромном адапторе, в цветном адапторе и в PCjr; но EGA не настолько совместим и по этой причине мы рекомендуем Вам избегать прямого программирования микросхемы, когда BIOS может выполнить работу за Вас. Говоря общими словами, микросхема 6845 устанавливает видеодисплей в один из нескольких алфавитноцифровых или графических режимов. Она выполняет основную работу по интерпретации номеров кодов ASCII и поиску данных для вывода соответствующих символов в микросхеме ПЗУ (а иногда в оперативной памяти). Она декодирует значения атрибутов цвета и соответственно устанавливает экран. Она также создает курсор и управляет им. В архитектуре EGA часть этих функций распределена между другими микросхемами. <p> Микросхема 6845 имеет 18 управляющих регистров, пронумерованных от 0 до 17. Первые 10 регистров фиксируют горизонтальные и вертикальные параметры дисплея. Эти регистры, как правило, неинтересны для программистов, поскольку они автоматически устанавливаются BIOS при изменении режима экрана. Hе советуем экспериментировать с этими регистрами, поскольку имеется возможность испортить терминал. Регистры имеют размер 8 бит, но некоторые связаны в пары, чтобы хранить 16-битные величины. Пары #10-11 и #14-15 устанавливают форму {<a href="424.htm">4.2.4</a>} и местоположение {<a href="421.htm">4.2.1</a>} курсора. Пара #12-13 управляет страницами дисплея {<a href="453.htm">4.5.3</a>}. Пара #16-17 сообщает позицию светового пера {<a href="732.htm">7.3.2</a>}. Большинство регистров доступно только для записи; только регистр адреса курсора можно и читать и писать, а регистр светового пера предназначен только для чтения. EGA имеет 6 добавочных регистров, которые связаны с техническими деталями. Регистр 20 наиболее интересен; он определяет какая линия сканирования в строке символа используется для подчеркивания. <p> Доступ ко всем 18 регистрам осуществляется через один и тот же порт, адрес которого для монохромного адаптора равен 3B5H. Этот адрес равен 3D5H для цветного адаптора и PCjr (заметим, что все адреса портов для монохромного адаптора такие же, как и для цветного, за исключением того, что средней цифрой является B, а не D). EGA использует один из этих двух адресов, в зависимости от того, присоединен ли к нему цветной или монохромный монитор. Для записи в регистр монохромного адаптора надо сначала в регистр адреса, расположенный в порте 3B4H (3D4H для цветного), послать номер требуемого регистра. Тогда следующий байт, посланный в порт с адресом 3B5H будет записан в этот регистр. Поскольку регистры, интересные для программиста, используются попарно, то надо сначала записать в адресный регистр, потом в первый регистр пары, потом снова в адресный регистр и, наконец, во второй регистр пары. Поскольку адреса портов смежные, то легче всего адресовать их, используя инструкции INC и DEC, как в следующем примере: <table align="center"> <tr><td></td><td>;---запись в регистры 11 и 12 микросхемы 6845 (данные в BX)</td></tr> <tr><td></td><td>;---выбираем регистр младшего байта</td></tr> <tr><td>MOV DX,3B4H </td><td>;порт адресного регистра</td></tr> <tr><td>MOV AL,11 </td><td>;номер регистра для младшего байта</td></tr> <tr><td>OUT DX,AL </td><td>;посылаем номер регистра</td></tr> <tr><td></td><td>;---посылаем байт</td></tr> <tr><td>INC DX </td><td>;увеличиваем адрес порта</td></tr> <tr><td>MOV AL,BL </td><td>;берем младший байт</td></tr> <tr><td>OUT DX,AL </td><td>;посылаем его в регистр 11</td></tr> <tr><td></td><td>;---выбираем регистр старшего байта</td></tr> <tr><td>DEC DX </td><td>;восстанавливаем адрес порта</td></tr> <tr><td>MOV AL,12 </td><td>;номер регистра для старшего байта</td></tr> <tr><td>OUT DX,AL </td><td>;посылаем номер регистра</td></tr> <tr><td></td><td>;---посылаем байт</td></tr> <tr><td>INC DX </td><td>;увеличиваем адрес порта</td></tr> <tr><td>MOV AL,BH </td><td>;берем старший байт</td></tr> <tr><td>OUT DX,AL </td><td>;посылаем его в регистр 12</td></tr> </table> <p> У монохромного и цветного адапторов имеются еще три порта, которые важны для программистов. Они имеют адреса 3B8H, 3B9H и 3BAH для монохромного и 3D8H, 3D9H и 3DAH - для цветного адаптора. Первый устанавливает режим экрана, второй - связан в основном с установкой цветов экрана, а третий сообщает полезную информацию о статусе дисплея. <p> PCjr использует не все эти адреса аналогичным образом. Вместо этого, он держит часть информации, относящейся к этим портам, в микросхеме массива ворот дисплея, основное назначение которой обеспечить дополнительное управление цветами экрана. Доступ к массиву ворот дисплея осуществляется через порт с адресом 3DAH. У цветного адаптора этот порт возвращает байт статуса; у PCjr этот порт также возвращает байт статуса при использовании инструкции IN, но он предоставляет доступ к массиву ворот, когда используется инструкция OUT. Массив ворот дисплея имеет следующие регистры: <pre class="asm"> 
         Hомер             Hазначение 
           0               режим управления 1 
           1               маска набора цветов (палетты) 
           2               цвет границы 
           3               режим управления 2 
           4               сброс 
           10H-1FH         назначение цветов палетты 
</pre> 
<p> Доступ ко всем регистрам осуществляется через порт 3DAH. Сначала надо послать в этот порт номер требуемого регистра, а затем значение этого регистра. Порт автоматически переключается между этими функциями работы с адресами и с данными. Чтобы он начал ожидать ввод адреса, надо прочитать его. Отдельные регистры обсуждаются в различных местах этой главы. <p> Особый интерес представляют 16 регистров палетты с номерами от 10H до 1FH. Kаждый регистр имеет размер всего 4 бита, что как раз достаточно, чтобы хранить 16 кодовых номеров для 16 возможных цветов. Для каждой позиции символа или точки на экране видеобуфер содержит данные, указывающие каким цветом должен выводиться этот объект. Эту информацию называют данными атрибутов. В отличие от цветного графического адаптора PCjr не использует данные атрибутов для непосредственного определения цвета, который будет выводиться. Вместо этого данные атрибутов являются указателями на один из 16 регистров палетты, а число, содержащееся в этом регистре, определяет каким цветом будет выводиться данный символ. При таком методе, программе нужно изменить только установку регистра палетты, и все символы или точки с соответствующим атрибутом изменят свой цвет. Регистры палетты работают во всех режимах, как текстовых, так и графических. <p> EGA распределяет эти функции между микросхемой контроллера атрибутов (адрес порта 3C0H) и двумя микросхемами контроллера графики (адреса портов 3CCH-3CFH). Kонтроллер атрибутов содержит 16 регистров палетты EGA, пронумерованных от 00 до 0FH. Эти регистры могут содержать 6-битные коды цветов, когда EGA связан с улучшенным цветным дисплеем, поэтому могут быть использованы любые 16 цветов из набора 64-х. В {<a href="441.htm">4.4.1</a>} показано как программировать регистры палетты для PCjr и EGA. <hr><p align="center">
<~-<a href="410.htm">Глава 4. Вывод на терминал.</a><br><a href="index.htm#header">Содержание</a><br><a href="412.htm">4.1.2 Установка/проверка режима дисплея.</a>-~>
</p></body></html>
