<html><head><title>Справочник программиста на персональном компьютере фирмы IBM.Роберт Журден</title> <meta http-equiv="Content-Type" content="text/html; charset=windows-1251"> <link rel=stylesheet type=text/css href=style.css> </head><body> <p class="hdr1">Глава 2. Таймеры и звук.</p> <p class="hdr2">Раздел 2. Создание звука.</p> <p class="hdr3">2.2.2 Генерация тона.</p> <p> Этот подраздел объясняет как производить звук, когда компьютер не занят ничем другим; в {<a href="223.htm">2.2.3</a>} показано как это сделать, когда производятся другие действия. Забавно, но для программистов на ассемблере последнее проще. Для этого достаточно запрограммировать микросхему таймера 8253, которая работает независимо от процессора. В приведенном здесь методе процессор непосредственно управляет динамиком, поэтому программе приходится выполнять работу, которую может выполнять микросхема таймера. Хотя этот способ более труден, но он допускает существенно больший контроль над динамиком и создание большинства специальных звуковых эффектов {<a href="228.htm">2.2.8</a>} основывается на нем. <p> Hизкий уровень. <p> Генерация звука с помощью адаптера интерфейса с периферией 8255 состоит во включении и выключении с желаемой частотой бита порта B, который связан с динамиком (бит 1). Порт B имеет адрес 61H (хотя AT не имеет микросхемы интерфейса с периферией 8255 как таковой, он использует для этой цели тот же адрес порта и тот же бит). Если программа переключает значение бита с максимально возможной частотой, то частота слишком высокая, чтобы быть полезной. Поэтому между двумя переключениями надо вставлять пустой цикл. Помните, что бит 0 порта B управляет воротами канала 2 микросхемы таймера, который в свою очередь связан с динамиком. Поэтому этот бит должен быть сброшен, отсоединяясь от канала таймера. Hа рис. 2-4 показано как этот метод устанавливает частоту звука. <p> В следующем примере введены две переменные. Одна, обозначенная "FREQUENCY", используется в качестве счетчика в пустом цикле между действиями включения и выключения. Чем меньше ее значение, тем быстрее происходит изменение бита и тем больше частота. Переменная же "NUMBER_CYCLES" устанавливает продолжительность тона. Она говорит сколько раз должен быть повторен процесс включения и выключения. Чем больше это число, тем дольше звучит данный звук. <p> Отметим, что для этой процедуры аппаратные прерывания должны быть запрещены. Причина этого в том, что прерывание таймера происходит с такой частотой и регулярностью (18.2 раза в секунду), что оно будет существенно влиять на частоту. Имейте ввиду, что пока прерывания запрещены, счетчик времени суток BIOS не будет работать. Если затем прочитать его значение, то оно будет отличаться на некоторую величину от реального, до тех пор, пока не будет сделано соответствующее изменение. <table align="center"> <tr><td>NUMBER_CYCLES EQU 1000</td><td></td></tr> <tr><td>FREQUENCY EQU 300</td><td></td></tr> <tr><td>PORT_B EQU 61H</td><td></td></tr> <tr><td>CLI </td><td>;запрет прерываний</td></tr> <tr><td>MOV DX,NUMBER_CYCLES </td><td>;длительность тона в DX</td></tr> <tr><td>IN AL,PORT_B </td><td>;получаем значение из порта B</td></tr> <tr><td>AND AL,11111110B </td><td>;отключаем динамик от таймера</td></tr> <tr><td>NEXT_CYCLE: OR AL,00000010B </td><td>;включаем динамик</td></tr> <tr><td>OUT PORT_B,AL </td><td>;посылаем команду в порт B</td></tr> <tr><td>MOV CX,FREQUENCY </td><td>;задержка на пол-цикла в CX</td></tr> <tr><td>FIRST_HALF: LOOP FIRST_HALF </td><td>;делаем задержку</td></tr> <tr><td>AND AL,11111101B </td><td>;выключаем динамик</td></tr> <tr><td>OUT PORT_B,AL </td><td>;посылаем команду в порт B</td></tr> <tr><td>MOV CX,FREQUENCY </td><td>;задержка на пол-цикла в CX</td></tr> <tr><td>SECOND_HALF: LOOP SECOND_HALF </td><td>;делаем задержку</td></tr> <tr><td>DEC DX </td><td>;вычитаем единицу из счетчика</td></tr> <tr><td>JNZ NEXT_CYCLE </td><td>;если 0, то надо кончать</td></tr> <tr><td>STI </td><td>;разрешаем прерывания</td></tr> </table> <hr><p align="center">
<~-<a href="221.htm">2.2.1. Генерация звука на PCjr (вырезано)</a><br><a href="index.htm#header">Содержание</a><br><a href="223.htm">2.2.3 Генерация звука одновременно с другими действиями.</a>-~>
</p></body></html>
