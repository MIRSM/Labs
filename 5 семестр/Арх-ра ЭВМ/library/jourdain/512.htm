<html><head><title>Справочник программиста на персональном компьютере фирмы IBM.Роберт Журден</title> <meta http-equiv="Content-Type" content="text/html; charset=windows-1251"> <link rel=stylesheet type=text/css href=style.css> </head><body> <p class="hdr1">Глава 5. Дисковые накопители.</p> <p class="hdr2">Раздел 1. Управление распределением диска.</p> <p class="hdr3">5.1.3 Получение/установка размера файла.</p> <p> Программа может пожелать проверить размер файла по разным причинам. Одна из возможных причин состоит в определении числа записей, содержащихся в файле. Другая - в определении позиции конца файла, с тем чтобы файловый указатель был установлен верно для добавления в файл новых данных, без изменения существующих. <p> Kонечно, размер файла устанавливается автоматически функцией DOS. Иногда программа может нуждаться в резервировании дискового  пространства для дальнейшего использования. В этом случае надо открыть файл в режиме прямого доступа и записать такой номер записи, чтобы файл имел достаточную длину. Записи между "фиктивной" и реально относящимися к файлу будут заполнены теми данными, которые случайно окажутся в дисковых секторах, отведенных для файла при этой операции. <p> Средний уровень. <p> FCB функция 23H прерывания 21H сообщает число записей в файле. Если приписать файлу длину записи в 1 байт, то его размер будет возвращен в байтах. DS:DX должны указывать на управляющий блок открытого файла. Затем вызовите функцию. Если файл не найден, то в AL возвращается FF. В противном случае в AL возвращается 0, а число записей помещается в поле номера записи прямого доступа FCB (байты 33-36). Для правильной работы поле длины записи FCB должно быть установлено после открытия файла, но перед вызовом функции; это двухбайтное поле расположено по смещению 14 в FCB. Если размер файла неточно делится на длину записи, то сообщаемое число записей округляется вверх. Вот пример, в котором используется длина записи равная 1: <table align="center"> <tr><td></td><td>;---определение размера файла</td></tr> <tr><td>LEA DX,FCB </td><td>;DS:DX указывает на FCB</td></tr> <tr><td>MOV BX,DX </td><td>;копируем указатель в BX</td></tr> <tr><td>MOV CX,1 </td><td>;размер записи в CX</td></tr> <tr><td>MOV [BX]+14,CX </td><td>;пишем в поле размера записи FCB</td></tr> <tr><td>MOV AH,23H </td><td>;функция сообщающая размер файла</td></tr> <tr><td>INT 21H </td><td>;вызов функции</td></tr> <tr><td>MOV AX,[BX]+33 </td><td>;получаем младшую часть размера файла</td></tr> <tr><td>MOV CX,[BX]+35 </td><td>;получаем старшую часть размера файла</td></tr> </table> <p> Можно также устанавливать длину файла, используя управляющие блоки файла. Для этого надо использовать функцию записи блока с прямым доступом, которая обсуждается в {<a href="545.htm">5.4.5</a>}. У этой функции имеется частный случай, когда число записанных записей устанавливается равным нулю, то длина файла устанавливается равной числу записей, указанному в поле записи прямого доступа. <p> Метод, использующий дескриптор файла (file handle) не имеет функции, которая непосредственно сообщала бы длину файла, однако имеется возможность вычислить размер, передвинув указатель файла с начала на конец файла. При открытии файла указатель файла автоматически устанавливается на первый байт файла. Указатель файла перемещается функцией 42H прерывания 21H. Hадо поместить в AL кодовое число 2, напраляющее указатель на конец файла. В BX должен быть указан номер файла, а CX:DX содержит смещение от конца файла до позиции, в которую должен быть установлен указатель, поэтому поместите 0 в оба этих регистра. Затем вызовите функцию. При возврате DX:AX будет содержать новую позицию указателя, относительно его предыдущей позиции - т.е. будет содержать длину файла (DX содержит старший байт). При возникновении ошибки будет установлен флаг переноса, а в AX будет возвращено 1, если неправилен номер функции и 6, если неправилен номер файла. Hе забудьте затем снова вернуть указатель на начало файла, если это необходимо. Поместите 0 в AL, CX и DX и вызовите функцию снова. Вот пример: <table align="center"> <tr><td></td><td>;---открываем файл</td></tr> <tr><td>LEA DX,FILE_PATH </td><td>;DS:DX указывают на путь файла</td></tr> <tr><td>MOV AL,0 </td><td>;открываем для чтения</td></tr> <tr><td>MOV AH,3DH </td><td>;функция открытия файла</td></tr> <tr><td>INT 21H </td><td>;открываем его</td></tr> <tr><td>JC OPEN_ERROR </td><td>;проверка на ошибку</td></tr> <tr><td>MOV HANDLE,AX </td><td>;запоминаем номер файла</td></tr> <tr><td></td><td>;---определяем длину файла</td></tr> <tr><td>MOV AH,42H </td><td>;функция перемещения указателя</td></tr> <tr><td>MOV AL,2 </td><td>;код установки на конец файла</td></tr> <tr><td>MOV BX,HANDLE </td><td>;номер файла в BX</td></tr> <tr><td>MOV CX,0 </td><td>;0 в CX и DX</td></tr> <tr><td>MOV DX,0 </td><td>;</td></tr> <tr><td>INT 21H </td><td>;сдвигаем указатель</td></tr> <tr><td>JC POINTER_ERROR </td><td>;ошибка?</td></tr> <tr><td>MOV FSIZE_HIGH,DX </td><td>;запоминаем размер файла</td></tr> <tr><td>MOV FSIZE_LOW,DX </td><td>;</td></tr> </table> <hr><p align="center">
<~-<a href="511.htm">5.1.1 Чтение таблицы размещения файлов.</a><br><a href="index.htm#header">Содержание</a><br><a href="513.htm">5.1.4 Восстановление после ошибок, связанных с нехваткой пространства на диске.</a>-~>
</p></body></html>
