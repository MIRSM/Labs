<html>
<head>
<title>FCNTL(2)</title>
		    <style type="text/css">
TH.arial { font-family: Arial, Serif;}
P.topic { font-family: sans-serif;}
A.plain { text-decoration: none;}
A.topic01 { color: #006890;
font-family: sans-serif;
text-decoration: none;}
A.topic02 { color: #099771;
font-family: sans-serif;
text-decoration: none;}
A.topic03 { color: #719709;
font-family: sans-serif;
text-decoration: none;}
A.topic04 { color: #98650A;
font-family: sans-serif;
text-decoration: none;}
A.topic05 { color: #98340A;
font-family: sans-serif;
text-decoration: none;}
A.topic06 { color: #099607;
font-family: sans-serif;
text-decoration: none;}
A.topic07 { color: #9E1215;
font-family: sans-serif;
text-decoration: none;}
A.topic08 { color: #970941;
font-family: sans-serif;
text-decoration: none;}
A.topic09 { color: #950995;
font-family: sans-serif;
text-decoration: none;}
A.topic010 { color: #390A98;
font-family: sans-serif;
text-decoration: none;}
H1 { font-family: sans-serif;}
H2 { font-family: sans-serif;}
H3 { font-family: sans-serif;}
H4 { font-family: sans-serif;}
H5 { font-family: sans-serif;}
H6 { font-family: sans-serif;}
</style>
</head>
<body bgcolor="#FFFFFF" link="#006890" vlink="#003860" alink="#800000" text="#000000">
<table cellspacing=0 cellpadding=0 border=0 background="_pic_/header0.jpg" width="100%">
<tr><td align="center">
<table cellspacing=0 cellpadding=4 border=0 width="100%" background="">
<tr><td align="left">
<img src="_pic_/logo.gif" width=157 height=53 border=0 alt="Server for Information Technologies">
</td><td align="right">
<font size="-2">Сервер поддерживается<br><a class="plain" href="http://www.citmgu.ru">Центром Информационных Технологий</a><br>(095) 932-9212, 932-9213, 939-0783<br>E-mail: <a class=noneline href="mailto:info@citmgu.ru?Subject='From page topic CIT FORUM local copy'">info@citforum.ru</a></font>
</td></tr>
</table>
<table cellspacing=0 cellpadding=4 border=0 width="100%" background="">
<tr><td align="left">
<font size="-1">Сервер содержит море(!) аналитической информации</font>
</td><td align="right">
<font size="-1">CIT Forum CD-ROM</font>
</td></tr>
</table>
</td></tr>
</table>

<h3 align=center>FCNTL(2)</H3>
<p><b>НАЗВАНИЕ</b><br>
fcntl - управление файлами
<p><b>СИНТАКСИС</b>
<pre>
        #include &lt;fcntl.h&gt;

        int fcntl (fildes, cmd, arg)
        int fildes, cmd, arg;
</pre>
<p align=justify><b>ОПИСАНИЕ</b><br>
Системный вызов fcntl  выполняет  управляющие  операции
над открытыми файлами. Аргумент fildes - это дескриптор
открытого файла, полученный после выполнения  системных
вызовов creat, open, dup, fcntl и pipe.
<p align=justify>
Аргумент  cmd может принимать следующие значения, определяющие выполняемую операцию:
<dl>
<dt>F_DUPFD 
<dd>Создать новый дескриптор файла с такими  свойствами:
<ol>
<li>Его номер - есть минимальный из доступных номеров, не меньших arg.
<li>Он ассоциирован с тем же открытым  файлом  (или
каналом), что и исходный дескриптор fildes.
<li>У  него тот же указатель текущей позиции в файле, что и у исходного (то  есть  они  разделяют
общий указатель).
<li>Тот  же  режим  доступа к файлу (чтение, запись
или чтение/запись).
<li>Те же флаги статуса файла (то есть оба дескриптора разделяют общие флаги статуса).
<li>Ассоциированный с новым дескриптором флаг "закрыть при выполнении вызова exec" устанавливается  в состояние "оставить открытым при выполнении вызова exec".
</ol>
<dt>F_GETFD 
<dd>Получить значение флага  "закрыть  при  выполнении
вызова  exec"  для  дескриптора файла fildes. Если
младший бит возвращаемого значения равен нулю,  то
файл  останется  открытым,  в противном случае при
выполнении вызова exec файл будет закрыт.
<dt>F_SETFD 
<dd>Установить значение флага "закрыть при  выполнении
вызова  exec"  для дескриптора файла fildes равным
значению младшего бита (0 или 1) аргумента arg.
<dt>F_GETFL 
<dd>Получить  флаги  статуса файла, ассоциированного с
дескриптором fildes.
<dt>F_SETFL 
<dd>Установить флаги статуса файла, ассоциированного с
дексриптором fildes,  равными  значению  аргумента
arg. Могут быть установлены только некоторые флаги
[см. <a href=FCNTL~1.htm>fcntl(5)</a>].
<dt>F_GETLK 
<dd>Получить характеристики первой блокировки,  мешающей установить новую блокировку, задаваемую структурой типа flock с адресом arg. Результирующая информация возвращается в той же структуре. Если нет
помех для создания нужной блокировки, то структура
flock  не изменяется за исключением поля типа блокировки, которому присваивается значение F_UNLCK.
<dt>F_SETLK 
<dd>Установить или снять блокировку сегмента  файла  в
соответствии со значением структуры типа flock, на
которую  указывает  аргумент  arg. [см. <a href=FCNTL~1.htm>fcntl(5)</a>].
Операция F_SETLK используется для установки блокировки на чтение (F_RDLCK) или запись (F_WRLCK),  а
также для снятия блокировки обоих типов (F_UNLCK).
Если блокировка на чтение или запись не может быть
установлена,  то системный вызов fcntl завершается
немедленно и возвращает -1.
<dt>F_SETLKW 
<dd>Эта операция отличается от операции F_SETLK только
тем, что при неудачной попытке  установить  блокировку  на  чтение  или  запись процесс переходит в
состояние ожидания до тех пор, пока нужный сегмент
файла не будет разблокирован.
</dl><p align=justify>
Блокировка  на чтение предотвращает блокировку защищаемой области каким-либо процессом на запись. Для данного
сегмента файла могут одновременно существовать несколько блокировок на чтение. Дескриптор,  используемый  для
установления блокировки на чтение, должен быть ассоциирован с файлом, открытым с правом чтения.
<p align=justify>
Блокировка на запись предотвращает блокировку  защищаемой  области  на  чтение или запись. Одновременно может
существовать не более одной блокировки на запись данного сегмента файла. Дескриптор, используемый  для  установления блокировки на запись, должен быть ассоциирован
с файлом, открытым с правом записи.
<p align=justify>
Структура  типа  flock  содержит поля, определяющие для
сегмента файла тип блокировки (l_type), начальное  смещение  (l_whence),  относительное  смещение  (l_start),
размер (l_len), идентификатор  системы  РУФ  (l_sysid),
идентификатор процесса (l_pid). Идентификаторы процесса
и системы используются только в случае операции F_GETLK
для  возврата  характеристик блокировки. Начало и конец
блокируемой области могут выходить за конец  файла,  но
не  за начало. Можно определить блокировку, всегда действующую до конца файла, если значение поля l_len равно
0. Если значения полей l_whence и l_start равны  0,  то
блокировка будет распространяться на весь файл. Изменение или снятие блокировки сегмента из середины большого
защищенного  сегмента приводит к появлению с обоих концов двух меньших защищенных сегментов. Блокировка  сегмента,  который  уже  блокирован  вызывающим процессом,
приводит к удалению старого  и  установке  нового  типа
блокировки.  Все  блокировки,  ассоциированные с файлом
для данного процесса, удаляются, когда файл закрывается
этим процессом или когда процесс терминируется, не закрывая файл. Блокировки не наследуются порождаемым  процессом при выполнении системного вызова <a href=FORK.htm>fork(2)</a>.
<p align=justify>
Если   блокировка   доступа   к  файлу  разрешена [см.
<a href=CHMOD~1.htm>chmod(2)</a>], то системные вызовы read и write  для  этого
файла выполняются с учетом действующих блокировок.
<p align=justify>
Системный вызов fcntl завершается неудачей, если выполнено хотя бы одно из следующих условий:
<dl>
<dt>[EBADF]
<dd>Аргумент  fildes  не  является   корректным
дескриптором открытого файла.
<dt>[EINVAL]
<dd>При операции cmd, равной F_DUPFD,  значение
аргумента arg либо отрицательно, либо больше или равно  максимально  допустимому  для
одного пользователя количеству дескрипторов
открытых файлов.
<dt>[EINVAL]
<dd>При  операции  cmd, равной F_GETLK, F_SETLK
или F_SETLKW, значение  аргумента  arg  или
информация,  на  которую указывает arg, некорректны.
<dt>[EACCES]
<dd>При операции cmd, равной F_SETLK,  делается
попытка  блокировать  на  чтение  (F_RDLCK)
сегмент файла, заблокированный другим  процессом  на запись, либо попытка блокировать
на запись (F_WRLCK) сегмент файла, заблокированный другим процессом на чтение или запись.
<dt>[ENOLCK]
<dd>При  операции  cmd,  равной   F_SETLK   или
F_SETLKW, превышается максимально  допустимое системой количество блокировок.
<dt>[EDEADLK]
<dd>При операции cmd, равной F_SETLKW, ожидание
возможности установить блокировку  приводит
к тупику.
<dt>[EFAULT]
<dd>При  операции cmd, равной F_SETLK, аргумент
arg указывает за пределы  отведенного  процессу адресного пространства.
<dt>[EINTR]
<dd>Во время выполнения системного  вызова  перехвачен сигнал.
<dt>[ENOLINK]
<dd>Дескриптор fildes ассоциирован с файлом  на
удаленном компьютере,  связи  с  которым  в
данный момент нет.
</dl>
<p><b>СМ. ТАКЖЕ</b><br>
<a href=CLOSE.htm>close(2)</a>, <a href=CREAT.htm>creat(2)</a>, <a href=DUP.htm>dup(2)</a>, <a href=EXEC.htm>exec(2)</a>, <a href=FORK.htm>fork(2)</a>,  <a href=OPEN.htm>open(2)</a>,
<a href=PIPE.htm>pipe(2)</a>, <a href=FCNTL~1.htm>fcntl(5)</a>.
<p align=justify><b>ДИАГНОСТИКА</b><br>
При успешном завершении системного вызова в зависимости
от операции cmd возвращаются следующие значения:
<ul>
<li><b>F_DUPFD</b> Новый дескриптор файла.
<li><b>F_GETFD</b> Значение флага  (определен  только  младший бит).
<li><b>F_SETFD</b> Значение, отличное от -1.
<li><b>F_GETFL</b> Значение флагов статуса файла.
<li><b>F_SETFL</b> Значение, отличное от -1.
<li><b>F_GETLK</b> Значение, отличное от -1.
<li><b>F_SETLK</b> Значение, отличное от -1.
<li><b>F_SETLKW</b> Значение, отличное от -1.
</ul>
В  случае  ошибки  возвращается  -1, а переменной errno
присваивается код ошибки.
<p align=justify><b>ПРЕДОСТЕРЕЖЕНИЯ</b><br>
Так  как в будущем переменной errno будет присваиваться
значение EAGAIN вместо EACCES в  случае,  если  сегмент
файла  уже  блокирован другим процессом, для достижения
мобильности прикладных программ следует ожидать и обрабатывать оба кода ошибки.
<table cellspacing=0 cellpadding=0 border=0 background="_pic_/footer0.jpg" width="100%">
<tr><td align="center">
<table cellspacing=0 cellpadding=4 border=0 width="100%" background="">
<tr><td align="right" valign="top" width="33%">
<font size="-2">Comments: <a class="plain" href="mailto:info@citmgu.ru?Subject='From bottom of CIT FORUM local copy'">info@citmgu.ru</a><br>
Designed by <a class="plain" href="mailto:andrey@novikov.com">Andrey Novikov</a><br>
Copyright &copy; <a class="plain" href="http://www.citmgu.ru/">CIT</a></font>
</td></tr>
</table>
</td></tr>
</table>
</body>
</html>
