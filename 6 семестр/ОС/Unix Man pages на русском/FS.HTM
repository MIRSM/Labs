<html>
<head>
<title>FS(4)</title>
		    <style type="text/css">
TH.arial { font-family: Arial, Serif;}
P.topic { font-family: sans-serif;}
A.plain { text-decoration: none;}
A.topic01 { color: #006890;
font-family: sans-serif;
text-decoration: none;}
A.topic02 { color: #099771;
font-family: sans-serif;
text-decoration: none;}
A.topic03 { color: #719709;
font-family: sans-serif;
text-decoration: none;}
A.topic04 { color: #98650A;
font-family: sans-serif;
text-decoration: none;}
A.topic05 { color: #98340A;
font-family: sans-serif;
text-decoration: none;}
A.topic06 { color: #099607;
font-family: sans-serif;
text-decoration: none;}
A.topic07 { color: #9E1215;
font-family: sans-serif;
text-decoration: none;}
A.topic08 { color: #970941;
font-family: sans-serif;
text-decoration: none;}
A.topic09 { color: #950995;
font-family: sans-serif;
text-decoration: none;}
A.topic010 { color: #390A98;
font-family: sans-serif;
text-decoration: none;}
H1 { font-family: sans-serif;}
H2 { font-family: sans-serif;}
H3 { font-family: sans-serif;}
H4 { font-family: sans-serif;}
H5 { font-family: sans-serif;}
H6 { font-family: sans-serif;}
</style>
</head>
<body bgcolor="#FFFFFF" link="#006890" vlink="#003860" alink="#800000" text="#000000">
<table cellspacing=0 cellpadding=0 border=0 background="_pic_/header0.jpg" width="100%">
<tr><td align="center">
<table cellspacing=0 cellpadding=4 border=0 width="100%" background="">
<tr><td align="left">
<img src="_pic_/logo.gif" width=157 height=53 border=0 alt="Server for Information Technologies">
</td><td align="right">
<font size="-2">Сервер поддерживается<br><a class="plain" href="http://www.citmgu.ru">Центром Информационных Технологий</a><br>(095) 932-9212, 932-9213, 939-0783<br>E-mail: <a class=noneline href="mailto:info@citmgu.ru?Subject='From page topic CIT FORUM local copy'">info@citforum.ru</a></font>
</td></tr>
</table>
<table cellspacing=0 cellpadding=4 border=0 width="100%" background="">
<tr><td align="left">
<font size="-1">Сервер содержит море(!) аналитической информации</font>
</td><td align="right">
<font size="-1">CIT Forum CD-ROM</font>
</td></tr>
</table>
</td></tr>
</table>

<h3 align=center>FS(4)</h3>
<p><b>НАЗВАНИЕ</b><br>
fs - формат тома, содержащего файловую систему
<p><b>СИНТАКСИС</b>
<pre>
#include &lt;sys/types.h&gt;
#include &lt;sys/param.h&gt;
#include &lt;sys/filsys.h&gt;
</pre>
<p align=justify><b>ОПИСАНИЕ</b><br>
На всех томах файловой системы хранится  в  стандартном
формате определенная жизненно важная информация. Каждый
том  (блочное  устройство)  разделен на некоторое количество секторов, имеющих длину 1024 байт.  Размер  всех
файлов  кратен,  а  внутренних буферов равен килобайту.
Рекомендуется пользоваться  константой  BUFSIZ,  равной
размеру  сектора.  Она  определена  во включаемом файле
&lt;stdio.h&gt;. Необходимо помнить  и  о  том,  что  утилиты
<a href=CPIO.htm>cpio(1)</a>, <a href=FSDB.htm>fsdb(1M)</a> в целях совместимости работают с 512 
байтными  блоками.  Еще  большей  осторожности  требует
бесструктурный ввод/вывод. Драйверы диска не  поддерживают  512-байтные  блоки, так что при использовании команды <a href=DD.htm>dd(1)</a> надо указывать размер буфера кратным  килобайту.  Правда, при нумерации блоков драйверы ввода/вывода по-прежнему считают их 512-байтными.
<p align=justify>
Первые 512 байт сектора 0 могут содержать информацию об
альтернативных дорожках. Вторая половина сектора 0  называется суперблоком.
<p align=justify>
Сектор 1 не используется. В секторах, начиная со второго, располагаются описатели файлов и собственно  файлы.
Системный том не содержит программы начальной загрузки.
<p>Суперблок имеет следующий формат:
<pre>
struct filsys {
  ushort  s_isize;          /* Размер списка описателей
                               файлов в блоках */
  daddr_t s_fsize;          /* Размер всего тома в
                               блоках */
  short   s_nfree;          /* Количество адресов в
                               массиве s_free */
  daddr_t s_free[NICFREE];  /* Список свободных блоков
                               */
  short   s_ninode;         /* Кол-во описателей фай- 
                               лов в масс. s_inode */
  ino_t   s_inode[NICINOD]; /* Список свободных описа- 
                               телей файлов */
  char    s_flock;          /* Блокир. при опер. со
                               списком своб. блоков */
  char    s_ilock;          /* Блокир. при опер. со
                               списком опис. файлов */
  char    s_fmod;           /* Флаг модификации супер- 
                               блока */
  char    s_ronly;          /* Флаг монтирования только
                               на чтение */
  time_t  s_time;           /* Время последнего обнов- 
                               ления суперблока */
  short   s_dinfo[4];       /* Информация об устройстве
                               */
  daddr_t s_tfree;          /* Кол-во свободных блоков
                               */
  ino_t   s_tinode;         /* Кол-во свободных описа- 
                               телей файлов */
  char    s_fname[6];       /* Имя файловой системы */
  char    s_fpack[6];       /* Имя тома */
  long    s_fill[14];       /* Заполнитель, чтобы
                               sizeof(filsys)==512 */
  long    s_state;          /* Состояние файловой сис- 
                               темы */
  long    s_magic;          /* Маг. число новой (вер- 
                               сии V.3) файл. сист. */
  long    s_type;           /* Тип новой файловой сис- 
                               темы */
};

#define FsMAGIC 0xfd187e20   /* Значение s_magic */

#define Fs1b    1            /* Блок по 512 байт */
#define Fs2b    2            /* Блок по 1024 байта */

#define FsOKAY   0x7c269d38  /* s_state: нормальная */
#define FsACTIVE 0x5e72d81a  /* s_state: активная */
#define FsBAD    0xcb096f43  /* s_state: плох.корень */
#define FsBADBLK 0xbadbc14b  /* s_state:  есть   плохие
                                блоки */
</pre><p align=justify>
Поле  s_type определяет тип файловой системы. В настоящее время поддерживаются два типа файловых систем: старая, с 512-байтными логическими блоками и новая,  улучшенная, с 1024-байтными блоками. Поле s_magic используется для того, чтобы отличить старую 512-байтную систему  от  новой.  Если значение этого поля не совпадает с
магическим числом FsMAGIC, то тип файловой системы принимается равным Fs1b, то есть система считается старой;
в противном случае используется значение s_type. Операционная система заботится о корректности преобразования
номеров логических блоков в номера физических секторов.
<p align=justify>
Поле s_state определяет состояние файловой системы. Для
успешно размонтированной, неповрежденной файловой  системы  s_state  имеет  значение  FsOKAY. После того, как
система была смонтирована с целью  внесения  изменений,
состояние  изменяется на FsACTIVE. По-особому обрабатывается корневая файловая система. Если во время загрузки ОС обнаруживается,  что  корневая  файловая  система
повреждена,  она  монтируется,  но отмечается признаком
FsBAD. Позже, после того, как она будет размонтирована,
будет установлено состояние FsOKAY.
<p align=justify>
Поле s_isize задает адрес первого  блока  данных  после
списка описателей файлов; сам список описателей начинается со второго блока. Таким образом, список описателей
файлов  имеет  длину  s_isize-2 блока. Значение s_fsize
есть первый блок, который потенциально  недоступен  для
размещения  файлов. Эти два числа используются системой
для выявления плохих номеров блоков; если неверный  номер  блока  получается  из списка свободных блоков или,
наоборот, освобождается, то на системную консоль  выводится  диагностическое  сообщение.  Более  того, список
свободных блоков очищается, чтобы  предотвратить  дальнейшее  получение номеров блоков из возможно поврежденного списка.
<p align=justify>
Список свободного пространства для каждого тома устроен
следующим образом. Массив s_free содержит до 50 номеров
свободных блоков s_free [0], ..., s_free [s_nfree - 1].
Блок  с номером s_free [0] является следующим элементом
списка свободного пространства. Нулевое слово  (длинное
целое) в этом блоке содержит количество (до 50) номеров
свободных  блоков,  указанных  в последующих 50 словах,
причем первое слово одновременно служит ссылкой на следующий элемент списка свободного пространства с  аналогичной структурой. Иными словами, каждый элемент списка
свободного  пространства располагается в начале свободного блока и устроен так же, как пара полей  s_nfree  и
s_free, играющая роль заголовка списка.
<p align=justify>
Чтобы занять свободный блок,  надо  уменьшить  значение
s_nfree и выделить блок с номером s_free [s_nfree]. Если  номер  выделенного блока равен 0, это означает, что
на томе нет свободных блоков, то есть имеет место ошибка. Если значение s_nfree стало нулевым,  нужно  прочитать выделенный блок, поместить его нулевое слово в поле s_nfree, а последующие 50 слов - в массив s_free.
<p align=justify>
При освобождении блока, если значение s_nfree равно 50,
следует скопировать пару полей s_nfree и s_free в начало этого блока, записать блок и установить s_nfree равным 0. В любом случае, номер освобождаемого блока помещается  в  элемент массива s_free [s_nfree], после чего
поле s_nfree увеличивается на 1.
<p align=justify>
Поле s_tfree хранит общее количество свободных  блоков,
доступных файловой системе.
<p align=justify>
Поле s_ninode хранит количество номеров свободных  описателей  файлов в массиве s_inode. Чтобы занять свободный описатель файла в случае, когда s_ninode больше  0,
это  поле следует уменьшить на 1 и выделить описатель с
номером s_inode [s_ninode]. Если же  значение  s_ninode
равно 0, нужно перебрать описатели файлов и номера свободных (не более 100) поместить в массив s_inode, после
чего снова попытаться выделить описатель.
<p align=justify>
При  освобождении  описателя,  если  значение  s_ninode
меньше 100, номер описателя следует поместить в элемент
массива s_inode [s_ninode] и увеличить поле s_ninode на
1. Если же значение s_ninode равно 100, не стоит  заботиться о регистрации факта освобождения.  Дело  в  том,
что  таблица номеров свободных описателей предназначена
только для ускорения их поиска; В самом описателе  есть
признак, свободен он или занят.
<p align=justify>
Значение s_tinode есть общее количество свободных  описателей файлов, доступных файловой системе.
<p align=justify>
Флаги  s_flock  и s_ilock поддерживаются только в копии
файловой системы в оперативной памяти; их  значения  на
диске  не  определены.  Значение  флага s_fmod на диске
также не поддерживается; этот флаг показывает, что  суперблок  был  изменен  и должен быть записан на диск во
время очередного обновления информации в файловой  системе.
<p>Флаг s_ronly означает защиту от записи.
<p align=justify>
Поле s_time есть время последней модификации суперблока
файловой  системы.  Оно  измеряется количеством секунд,
прошедших с 00:00:00 1 января 1970г. (по Гринвичу).
<p align=justify>
Поле s_fname есть имя файловой системы, а s_fpack - имя
тома.
<p align=justify>
Номера описателей файлов начинаются с 1. Длина описателя  составляет  64 байта. Описатель номер 1 в настоящее
время не используется. Описатель номер 2 зарезервирован
для корневого каталога файловой системы. Другие  описатели не имеют предопределенного назначения. Каждый описатель  соответствует  одному  файлу.  Формат описателя
файла см. в <a href=INODE.htm>inode(4)</a>.
<p><b>ФАЙЛЫ</b><br>
<pre>
/usr/include/sys/fs/*
</pre>
<p><b>СМ. ТАКЖЕ</b><br>
<a href=MOUNT~1.htm>mount(2)</a>, <a href=INODE.htm>inode(4)</a>.<br>
<a href=FINITO.htm>finito(1M)</a>, <a href=FSCK.htm>fsck(1M)</a>, <a href=FSDB.htm>fsdb(1M)</a>, <a href=MKFS.htm>mkfs(1M)</a> в  Справочнике
администратора.
<table cellspacing=0 cellpadding=0 border=0 background="_pic_/footer0.jpg" width="100%">
<tr><td align="center">
<table cellspacing=0 cellpadding=4 border=0 width="100%" background="">
<tr><td align="right" valign="top" width="33%">
<font size="-2">Comments: <a class="plain" href="mailto:info@citmgu.ru?Subject='From bottom of CIT FORUM local copy'">info@citmgu.ru</a><br>
Designed by <a class="plain" href="mailto:andrey@novikov.com">Andrey Novikov</a><br>
Copyright &copy; <a class="plain" href="http://www.citmgu.ru/">CIT</a></font>
</td></tr>
</table>
</td></tr>
</table>
</body>
</html>
